# ì „ì²´ ë°°í¬ ì½”ë“œ
name: ci

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

permissions:
  contents: read # ì½”ë“œ ì½ê¸° ê¶Œí•œ
  pull-requests: write # ìë™ë¦¬ë·°ì–´ ì„¤ì •ì„ ìœ„í•œ ì“°ê¸° ê¶Œí•œ

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # ì €ì¥ì†Œ ì½”ë“œ ë‹¤ìš´ë¡œë“œ
      - name: Checkout Code
        uses: actions/checkout@v5
      # pnpm ì„¤ì¹˜
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Get pnpm store directory
        id: pnpm-cache
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-

      # node.js í™˜ê²½ ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: "22.x"
          # cache: "pnpm" # ìºì‹±í•´ë†“ì€ íŒ¨í‚¤ì§€ ê´€ë¦¬ì
      # ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      # í”„ë¡œì íŠ¸ ë¦°íŠ¸ ê²€ì‚¬ ë° íƒ€ì… ê²€ì‚¬
      - name: Check project
        id: check_step
        run: pnpm run lint && pnpm exec tsc --noEmit
      # í”„ë¡œì íŠ¸ ë¹Œë“œ
      - name: Build project
        id: build_step
        run: pnpm run build
        continue-on-error: true

      # ë¹Œë“œ ê²°ê³¼
      - name: Output build result
        if: github.event_name == 'pull_request' && always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: build-result
          message: |
            ### ğŸš€ ë¹Œë“œ ê²°ê³¼
            ${{ steps.check_step.outcome == 'success' && 'âœ… **ë¦°íŠ¸ ê²€ì‚¬ ì™„ë£Œ**' || 'âŒ **ë¦°íŠ¸ ê²€ì‚¬ ì‹¤íŒ¨**'}}
            ${{ steps.build_step.outcome == 'success' && 'âœ… **ë¹Œë“œ ì„±ê³µ**' || 'âŒ **ë¹Œë“œ ì‹¤íŒ¨**' }}

            <details>
              <summary>ë¡œê·¸ í™•ì¸í•˜ê¸°</summary>
              <br> 
              <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">
                Actions íƒ­ì—ì„œ ìì„¸íˆ ë³´ê¸°
              </a>
            </details>

      # ë¹Œë“œ ê²°ê³¼ ë””ìŠ¤ì½”ë“œ ì•ŒëŒ ë³´ë‚´ê¸°
      - name: Notify Discord Alarm
        if: github.event_name == 'pull_request' && always()
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_USER="${{ github.event.pull_request.user.login }}"
          PR_URL="${{ github.event.pull_request.html_url }}"

          if [ "${{ steps.build_step.outcome }}" == "success" ]; then
            COLOR=3066993  
            TITLE="âœ… ë¹Œë“œ ì„±ê³µ"
          else
            COLOR=15158332 
            TITLE="âŒ ë¹Œë“œ ì‹¤íŒ¨"
          fi

          DESCRIPTION="**ğŸš€ Title :** \`$PR_TITLE\`\n **ğŸ‘¤ì‘ì„±ì :** \`$PR_USER\`\n\n**[ğŸ” PRë³´ëŸ¬ê°€ê¸°]($PR_URL)**"
          curl -H "Content-Type: application/json" \
               -d "{
                 \"embeds\": [{
                   \"title\": \"$TITLE\",
                   \"description\": \"$DESCRIPTION\",
                   \"color\": $COLOR
                 }]
               }" \
               "${{ secrets.DISCORD_WEBHOOK_URL }}"
      # ë¹Œë“œ ì‹¤íŒ¨ ì‹œ, ì¢…ë£Œ
      - name: Check Build Status
        if: steps.build_step.outcome == 'failure'
        run: exit 1
  assign:
    runs-on: ubuntu-latest
    steps:
      - name: auto-assign-author-and-reviewer
        if: github.event_name == 'pull_request'&&github.event.action=='opened'
        uses: hkusu/review-assign-action@v1
        with:
          assignees: ${{github.actor}} # ë‹´ë‹¹ì ì„¤ì •
          # reviewers: a, b, c (ë¦¬ë·°ì–´ë¥¼ ìë™ ì„¤ì •í•©ë‹ˆë‹¤)
